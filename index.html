<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vision Pro - çµ±åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- APIã‚­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* Chat Panel */
        .chat-panel {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 60px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #ddd;
        }

        .message.system {
            background: #28a745;
            color: white;
            text-align: center;
            max-width: 100%;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 15px;
            max-width: 80%;
            margin-bottom: 15px;
            font-style: italic;
            color: #666;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ai-provider-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 12px;
            background: white;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
        }

        .chat-input:disabled {
            background: #f5f5f5;
            color: #999;
        }

        /* Vision Panel */
        .vision-panel {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 60px;
        }

        .vision-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vision-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
        }

        #videoFeed {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            border: 3px solid #667eea;
            background: #000;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .status-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .status-processing {
            background: rgba(255, 193, 7, 0.9);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.9);
        }

        .analysis-results {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 120px;
        }

        .result-card h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
        }

        .result-content {
            font-size: 13px;
            line-height: 1.4;
            max-height: 100px;
            overflow-y: auto;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .modal-tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .input-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .api-status.untested {
            background: #fff3cd;
            color: #856404;
        }

        /* Analytics Panel */
        .analytics-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .analytics-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }

        .analytics-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .analytics-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .analysis-results {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 18px;
            }
        }

        .hidden {
            display: none;
        }

        /* Config error styles */
        .config-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
            border: 2px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Config error check -->
    <div id="configError" class="config-error hidden">
        <h2>âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
        <p>config.js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
        <p>è©³ç´°ã¯ README.md ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>ğŸš€ AI Vision Pro - çµ±åˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-controls">
            <button class="btn btn-info" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            <button class="btn btn-warning" onclick="showAnalytics()">ğŸ“Š çµ±è¨ˆ</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>ğŸ’¬ AI ãƒãƒ£ãƒƒãƒˆ</h2>
                <div>
                    <button class="btn btn-info" onclick="captureAndSend()" id="shareBtn" disabled>ğŸ“· ç”»åƒå…±æœ‰</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">AI Visionçµ±åˆãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ</div>
                <div class="message assistant">ã“ã‚“ã«ã¡ã¯ï¼ã¾ãšã¯âš™ï¸è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>
                <div class="message system" id="statusMessage">âŒ APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚âš™ï¸è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span>AI ãŒå…¥åŠ›ä¸­...</span>
            </div>
            
            <div class="chat-input-area">
                <select class="ai-provider-select" id="aiProvider">
                    <option value="gemini">Gemini</option>
                    <option value="claude">Claude</option>
                    <option value="gpt">ChatGPT</option>
                </select>
                <input type="text" class="chat-input" id="chatInput" placeholder="APIã‚­ãƒ¼ã‚’è¨­å®šå¾Œã€AIã¨ä¼šè©±ã§ãã¾ã™..." disabled onkeypress="handleChatKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>é€ä¿¡</button>
            </div>
        </div>

        <!-- Vision Panel -->
        <div class="vision-panel">
            <div class="vision-header">
                <h2>ğŸ‘ï¸ Live Vision Analysis</h2>
                <button class="btn btn-primary" id="visionToggle" onclick="toggleVision()" disabled>ğŸš€ é–‹å§‹</button>
            </div>

            <div class="vision-mode-tabs">
                <button class="tab active" data-mode="general">ç‰©ä½“åã®ã¿</button>
                <button class="tab" data-mode="detailed">è©³ç´°åˆ†æ</button>
                <button class="tab" data-mode="inventory">åœ¨åº«ç®¡ç†</button>
            </div>

            <div class="video-container">
                <video id="videoFeed" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="video-overlay" id="statusOverlay">ğŸ“¹ Camera Ready</div>
                <div class="status-indicator" id="statusIndicator">è¨­å®šãŒå¿…è¦</div>
            </div>

            <div class="analysis-results">
                <div class="result-card">
                    <h4>ğŸ” Vision API</h4>
                    <div class="result-content" id="visionResults">APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...</div>
                </div>
                <div class="result-card">
                    <h4>ğŸ¤– AIåˆ†æ</h4>
                    <div class="result-content" id="analysisResults">Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...</div>
                </div>
                <div class="result-card">
                    <h4>ğŸŒ ç¿»è¨³</h4>
                    <div class="result-content" id="translationResults">Translate APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...</div>
                </div>
                <div class="result-card">
                    <h4>ğŸ”Š éŸ³å£°</h4>
                    <div class="result-content" id="speechResults">Text-to-Speech APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-success" id="speechBtn" onclick="toggleSpeech()" disabled>ğŸ”‡ éŸ³å£°OFF</button>
                <button class="btn btn-info" onclick="takeSnapshot()" id="snapshotBtn" disabled>ğŸ“¸ ã‚¹ãƒŠãƒƒãƒ—</button>
                <select id="intervalSelect" disabled>
                    <option value="5000">5ç§’</option>
                    <option value="10000">10ç§’</option>
                    <option value="15000" selected>15ç§’</option>
                    <option value="30000">30ç§’</option>
                    <option value="60000">1åˆ†</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
                <button class="btn btn-danger" onclick="closeSettings()">âœ•</button>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="chat">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆAPI</button>
                <button class="modal-tab" data-tab="vision">ğŸ‘ï¸ Vision API</button>
                <button class="modal-tab" data-tab="analysis">ğŸ”¬ åˆ†æè¨­å®š</button>
            </div>

            <!-- Chat API Tab -->
            <div class="tab-content active" id="chat-tab">
                <h3>ãƒãƒ£ãƒƒãƒˆç”¨APIã‚­ãƒ¼è¨­å®š</h3>
                
                <div class="input-group">
                    <label for="geminiChatKey">Gemini API Key <span class="api-status untested" id="geminiChatStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="geminiChatKey" placeholder="AIza...">
                    <small>å–å¾—å…ˆ: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                </div>

                <div class="input-group">
                    <label for="claudeKey">Claude API Key <span class="api-status untested" id="claudeStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="claudeKey" placeholder="sk-ant-...">
                    <small>å–å¾—å…ˆ: <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a></small>
                </div>

                <div class="input-group">
                    <label for="openaiKey">OpenAI API Key <span class="api-status untested" id="openaiStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="openaiKey" placeholder="sk-...">
                    <small>å–å¾—å…ˆ: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></small>
                </div>

                <button class="btn btn-primary" onclick="testChatAPIs()">ğŸ§ª ãƒãƒ£ãƒƒãƒˆAPIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            </div>

            <!-- Vision API Tab -->
            <div class="tab-content" id="vision-tab">
                <h3>Vision & Live Analysis APIè¨­å®š</h3>
                
                <div class="input-group">
                    <label for="geminiVisionKey">Gemini API Key (ç”»åƒåˆ†æç”¨) <span class="api-status untested" id="geminiVisionStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="geminiVisionKey" placeholder="AIza...">
                    <small>Google AI Studioã§å–å¾—ï¼ˆãƒãƒ£ãƒƒãƒˆç”¨ã¨åŒã˜ã§ã‚‚OKï¼‰</small>
                </div>

                <div class="input-group">
                    <label for="visionKey">Google Vision API Key <span class="api-status untested" id="visionApiStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="visionKey" placeholder="AIza...">
                    <small>å–å¾—å…ˆ: Google Cloud Console â†’ APIs & Services â†’ Credentials</small>
                </div>

                <div class="input-group">
                    <label for="translateKey">Google Translate API Key <span class="api-status untested" id="translateStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="translateKey" placeholder="AIza...">
                    <small>é€šå¸¸ã¯Vision API Keyã¨åŒã˜</small>
                </div>

                <div class="input-group">
                    <label for="ttsKey">Text-to-Speech API Key <span class="api-status untested" id="ttsStatus">æœªãƒ†ã‚¹ãƒˆ</span></label>
                    <input type="password" id="ttsKey" placeholder="AIza...">
                    <small>é€šå¸¸ã¯Vision API Keyã¨åŒã˜</small>
                </div>

                <button class="btn btn-primary" onclick="testVisionAPIs()">ğŸ§ª Vision APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            </div>

            <!-- Analysis Settings Tab -->
            <div class="tab-content" id="analysis-tab">
                <h3>Live Vision Analysis è¨­å®š</h3>
                
                <div class="input-group">
                    <label for="analysisMode">åˆ†æãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="analysisMode">
                        <option value="general">ç‰©ä½“åã®ã¿ï¼ˆç°¡æ½”ï¼‰</option>
                        <option value="detailed">è©³ç´°åˆ†æ</option>
                        <option value="objects">ç‰©ä½“æ¤œå‡ºé‡è¦–</option>
                        <option value="text">æ–‡å­—èªè­˜é‡è¦–</option>
                        <option value="scene">ã‚·ãƒ¼ãƒ³ç†è§£</option>
                        <option value="inventory">åœ¨åº«ç®¡ç†ç”¨</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="customInstruction">ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <textarea id="customInstruction" rows="3" placeholder="ç‰¹åˆ¥ãªåˆ†ææŒ‡ç¤ºãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>

                <div class="input-group">
                    <label for="speechSpeed">éŸ³å£°é€Ÿåº¦</label>
                    <select id="speechSpeed">
                        <option value="0.7">é…ã‚</option>
                        <option value="1.0" selected>æ¨™æº–</option>
                        <option value="1.3">é€Ÿã‚</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="autoSpeech"> åˆ†æçµæœã‚’è‡ªå‹•ã§éŸ³å£°èª­ã¿ä¸Šã’
                    </label>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn btn-warning" onclick="loadSettings()">ğŸ”„ è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                <button class="btn btn-danger" onclick="resetSettings()">ğŸ—‘ï¸ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal-overlay" id="analyticsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“Š ä½¿ç”¨çµ±è¨ˆ</h2>
                <button class="btn btn-danger" onclick="closeAnalytics()">âœ•</button>
            </div>
            
            <div class="analytics-panel">
                <div class="analytics-grid">
                    <div class="analytics-item">
                        <div class="analytics-value" id="totalAnalyses">0</div>
                        <div class="analytics-label">ç·åˆ†æå›æ•°</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="successRate">0%</div>
                        <div class="analytics-label">æˆåŠŸç‡</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="totalCost">$0.00</div>
                        <div class="analytics-label">æ¨å®šã‚³ã‚¹ãƒˆ</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="avgTime">0.0s</div>
                        <div class="analytics-label">å¹³å‡å‡¦ç†æ™‚é–“</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Config check
        let CONFIG_AVAILABLE = false;
        try {
            if (typeof CONFIG !== 'undefined' && CONFIG.GEMINI_API_KEY) {
                CONFIG_AVAILABLE = true;
            }
        } catch (error) {
            console.warn('Config file not found');
        }

        // Show error if config is not available
        if (!CONFIG_AVAILABLE) {
            document.getElementById('configError').classList.remove('hidden');
            // Create dummy CONFIG to prevent errors
            window.CONFIG = {
                GEMINI_API_KEY: '',
                OPENAI_API_KEY: '',
                CLAUDE_API_KEY: '',
                GOOGLE_VISION_API_KEY: '',
                GOOGLE_TRANSLATE_API_KEY: '',
                GOOGLE_TTS_API_KEY: ''
            };
        }

        // System state
        let isVisionActive = false;
        let speechEnabled = false;
        let currentMode = 'general';
        let stream = null;
        let analysisInterval = null;
        let conversationHistory = [];
        let lastAnalysisTime = 0;
        let isProcessing = false;
        let currentAudio = null;

        // Analytics
        let analytics = {
            total: 0,
            successful: 0,
            totalProcessingTime: 0,
            estimatedCost: 0
        };

        // Default instructions (Japanese prompts)
        const defaultInstructions = {
            general: "ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ä¸»è¦ãªç‰©ä½“ã‚’ç°¡æ½”ã«æ—¥æœ¬èªã§åˆ—æŒ™ã—ã¦ãã ã•ã„ã€‚è©³ã—ã„èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚",
            detailed: "ã“ã®ç”»åƒã«ã¤ã„ã¦ã€ç‰©ä½“ã€äººã€æ´»å‹•ã€è¨­å®šã€è‰²ã€æ³¨ç›®ã™ã¹ãè©³ç´°ã‚’å«ã‚ã¦åŒ…æ‹¬çš„ã«åˆ†æã—ã¦ãã ã•ã„ã€‚",
            objects: "ã“ã®ç”»åƒã«è¦‹ãˆã‚‹å…¨ã¦ã®ç‰©ä½“ã‚’ç‰¹å®šã—ã€ãŠãŠã‚ˆãã®ä½ç½®ã¨å…±ã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚",
            text: "ã“ã®ç”»åƒã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã€çœ‹æ¿ã€ãƒ©ãƒ™ãƒ«ã€æ–‡å­—ã‚’å…¨ã¦èª­ã¿å–ã£ã¦è»¢å†™ã—ã¦ãã ã•ã„ã€‚",
            scene: "ã“ã®ã‚·ãƒ¼ãƒ³ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼šä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿæ–‡è„ˆã¯ï¼ŸçŠ¶æ³ã«ã¤ã„ã¦ä½•ãŒæ¨æ¸¬ã§ãã‚‹ã‹ï¼Ÿ",
            inventory: "ã“ã®ç”»åƒã®å•†å“ã‚„ç‰©å“ã‚’ç‰¹å®šã—ã€åœ¨åº«ç®¡ç†ã®è¦³ç‚¹ã‹ã‚‰é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚"
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            
            // ã‚«ãƒ¡ãƒ©åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            checkCameraAvailability();
            
            // Load config values if available
            if (CONFIG_AVAILABLE) {
                loadConfigValues();
            }
            
            loadSettings();
            checkAPIStatus();
        });

        // ã‚«ãƒ¡ãƒ©åˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
        async function checkCameraAvailability() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                }

                // åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒã‚¤ã‚¹ã‚’ç¢ºèª
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    throw new Error('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                console.log(`${videoDevices.length} å€‹ã®ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:`, videoDevices);
                document.getElementById('statusOverlay').textContent = `ğŸ“¹ Camera Ready (${videoDevices.length}å°)`;
                
            } catch (error) {
                console.error('Camera availability check failed:', error);
                document.getElementById('statusOverlay').textContent = `âŒ ${error.message}`;
                document.getElementById('statusIndicator').textContent = 'ã‚«ãƒ¡ãƒ©åˆ©ç”¨ä¸å¯';
                document.getElementById('statusIndicator').className = 'status-indicator status-error';
                
                // Vision toggleãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.getElementById('visionToggle').disabled = true;
                document.getElementById('visionToggle').textContent = 'âŒ ã‚«ãƒ¡ãƒ©ç„¡ã—';
            }
        }

        // Load values from config.js into settings
        function loadConfigValues() {
            if (CONFIG.GEMINI_API_KEY) {
                document.getElementById('geminiChatKey').value = CONFIG.GEMINI_API_KEY;
                document.getElementById('geminiVisionKey').value = CONFIG.GEMINI_API_KEY;
            }
            if (CONFIG.OPENAI_API_KEY) {
                document.getElementById('openaiKey').value = CONFIG.OPENAI_API_KEY;
            }
            if (CONFIG.CLAUDE_API_KEY) {
                document.getElementById('claudeKey').value = CONFIG.CLAUDE_API_KEY;
            }
            if (CONFIG.GOOGLE_VISION_API_KEY) {
                document.getElementById('visionKey').value = CONFIG.GOOGLE_VISION_API_KEY;
            }
            if (CONFIG.GOOGLE_TRANSLATE_API_KEY) {
                document.getElementById('translateKey').value = CONFIG.GOOGLE_TRANSLATE_API_KEY;
            }
            if (CONFIG.GOOGLE_TTS_API_KEY) {
                document.getElementById('ttsKey').value = CONFIG.GOOGLE_TTS_API_KEY;
            }
        }

        // Settings management
        function setupTabs() {
            // Vision mode tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode || 'general';
                });
            });

            // Modal tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            
            // è¨­å®šç”»é¢ã‚’é–‹ã„ãŸã¨ãã«ã‚«ãƒ¡ãƒ©çŠ¶æ³ã‚‚è¡¨ç¤º
            showCameraInfo();
        }

        // ã‚«ãƒ¡ãƒ©æƒ…å ±ã‚’è¡¨ç¤º
        async function showCameraInfo() {
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    console.log('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', videoDevices);
                    
                    // HTTPSã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                    const isHTTPS = location.protocol === 'https:';
                    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                    
                    if (!isHTTPS && !isLocalhost) {
                        console.warn('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™');
                        addChatMessage('system', 'âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚GitHub Pagesã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showAnalytics() {
            updateAnalyticsDisplay();
            document.getElementById('analyticsModal').style.display = 'flex';
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        function saveSettings() {
            const settings = {
                geminiChatKey: document.getElementById('geminiChatKey').value,
                claudeKey: document.getElementById('claudeKey').value,
                openaiKey: document.getElementById('openaiKey').value,
                geminiVisionKey: document.getElementById('geminiVisionKey').value,
                visionKey: document.getElementById('visionKey').value,
                translateKey: document.getElementById('translateKey').value,
                ttsKey: document.getElementById('ttsKey').value,
                analysisMode: document.getElementById('analysisMode').value,
                customInstruction: document.getElementById('customInstruction').value,
                speechSpeed: document.getElementById('speechSpeed').value,
                autoSpeech: document.getElementById('autoSpeech').checked
            };

            localStorage.setItem('aiVisionSettings', JSON.stringify(settings));
            addChatMessage('system', 'âš™ï¸ è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
            checkAPIStatus();
        }

        function loadSettings() {
            const saved = localStorage.getItem('aiVisionSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                
                // Only load if not already loaded from config
                if (!CONFIG_AVAILABLE) {
                    document.getElementById('geminiChatKey').value = settings.geminiChatKey || '';
                    document.getElementById('claudeKey').value = settings.claudeKey || '';
                    document.getElementById('openaiKey').value = settings.openaiKey || '';
                    document.getElementById('geminiVisionKey').value = settings.geminiVisionKey || '';
                    document.getElementById('visionKey').value = settings.visionKey || '';
                    document.getElementById('translateKey').value = settings.translateKey || '';
                    document.getElementById('ttsKey').value = settings.ttsKey || '';
                }
                
                document.getElementById('analysisMode').value = settings.analysisMode || 'general';
                document.getElementById('customInstruction').value = settings.customInstruction || '';
                document.getElementById('speechSpeed').value = settings.speechSpeed || '1.0';
                document.getElementById('autoSpeech').checked = settings.autoSpeech || false;

                addChatMessage('system', 'ğŸ”„ è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
                checkAPIStatus();
            }
        }

        function resetSettings() {
            if (confirm('å…¨ã¦ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('aiVisionSettings');
                document.querySelectorAll('#settingsModal input, #settingsModal select, #settingsModal textarea').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                // Reload config values if available
                if (CONFIG_AVAILABLE) {
                    loadConfigValues();
                }
                
                addChatMessage('system', 'ğŸ—‘ï¸ è¨­å®šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ');
                checkAPIStatus();
            }
        }

        function checkAPIStatus() {
            const geminiChat = document.getElementById('geminiChatKey').value.trim();
            const geminiVision = document.getElementById('geminiVisionKey').value.trim();
            const vision = document.getElementById('visionKey').value.trim();
            const translate = document.getElementById('translateKey').value.trim();
            const tts = document.getElementById('ttsKey').value.trim();

            // Enable/disable UI based on API key availability
            const hasChatAPI = geminiChat || document.getElementById('claudeKey').value.trim() || document.getElementById('openaiKey').value.trim();
            const hasVisionAPI = geminiVision && vision;
            const hasFullVisionAPI = hasVisionAPI && translate && tts;

            // Update UI states
            document.getElementById('chatInput').disabled = !hasChatAPI;
            document.getElementById('sendBtn').disabled = !hasChatAPI;
            document.getElementById('visionToggle').disabled = !hasVisionAPI;
            document.getElementById('shareBtn').disabled = !hasVisionAPI;
            document.getElementById('snapshotBtn').disabled = !hasVisionAPI;
            document.getElementById('speechBtn').disabled = !tts;
            document.getElementById('intervalSelect').disabled = !hasVisionAPI;

            // Update placeholders and messages
            if (hasChatAPI) {
                document.getElementById('chatInput').placeholder = 'AIã¨ä¼šè©±ã—ã¦ã¿ã¾ã—ã‚‡ã†...';
            } else {
                document.getElementById('chatInput').placeholder = 'APIã‚­ãƒ¼ã‚’è¨­å®šå¾Œã€AIã¨ä¼šè©±ã§ãã¾ã™...';
            }

            // Update status messages
            if (hasFullVisionAPI) {
                document.getElementById('statusIndicator').textContent = 'æº–å‚™å®Œäº†';
                document.getElementById('statusIndicator').className = 'status-indicator';
                document.getElementById('visionResults').textContent = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„...';
                document.getElementById('analysisResults').textContent = 'åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
                document.getElementById('translationResults').textContent = 'ç¿»è¨³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
                document.getElementById('speechResults').textContent = 'éŸ³å£°å†ç”Ÿã®çŠ¶æ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
            } else if (hasVisionAPI) {
                document.getElementById('statusIndicator').textContent = 'ä¸€éƒ¨APIæœªè¨­å®š';
                document.getElementById('statusIndicator').className = 'status-indicator status-processing';
                if (!translate) document.getElementById('translationResults').textContent = 'Translate APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
                if (!tts) document.getElementById('speechResults').textContent = 'Text-to-Speech APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
            } else {
                document.getElementById('statusIndicator').textContent = 'è¨­å®šãŒå¿…è¦';
                document.getElementById('statusIndicator').className = 'status-indicator status-error';
                if (!geminiVision) document.getElementById('analysisResults').textContent = 'Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
                if (!vision) document.getElementById('visionResults').textContent = 'Vision APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
                if (!translate) document.getElementById('translationResults').textContent = 'Translate APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
                if (!tts) document.getElementById('speechResults').textContent = 'Text-to-Speech APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„...';
            }

            // Update chat message if status changed
            updateChatStatusMessage(hasChatAPI, hasVisionAPI);
        }

        function updateChatStatusMessage(hasChatAPI, hasVisionAPI) {
            const statusMessage = document.getElementById('statusMessage');
            
            let message = '';
            if (hasChatAPI && hasVisionAPI) {
                message = 'âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ï¼ãƒãƒ£ãƒƒãƒˆã¨Live Vision AnalysisãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚';
            } else if (hasChatAPI) {
                message = 'âš ï¸ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã€‚Visionæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Vision APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚';
            } else if (hasVisionAPI) {
                message = 'âš ï¸ Visionæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã€‚ãƒãƒ£ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒãƒ£ãƒƒãƒˆç”¨APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚';
            } else {
                message = 'âŒ APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚âš™ï¸è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚';
            }
            
            statusMessage.textContent = message;
        }

        // API Testing functions (same as original)
        async function testChatAPIs() {
            const geminiKey = document.getElementById('geminiChatKey').value.trim();
            if (geminiKey) {
                updateAPIStatus('geminiChatStatus', 'testing', 'ãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'Hello' }] }],
                            generationConfig: { maxOutputTokens: 10 }
                        })
                    });
                    
                    if (response.ok) {
                        updateAPIStatus('geminiChatStatus', 'connected', 'æ¥ç¶šOK');
                    } else {
                        updateAPIStatus('geminiChatStatus', 'disconnected', `ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                } catch (error) {
                    updateAPIStatus('geminiChatStatus', 'disconnected', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
                }
            } else {
                updateAPIStatus('geminiChatStatus', 'untested', 'æœªè¨­å®š');
            }

            const claudeKey = document.getElementById('claudeKey').value.trim();
            if (claudeKey) {
                updateAPIStatus('claudeStatus', 'untested', 'ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…å¿…è¦');
            } else {
                updateAPIStatus('claudeStatus', 'untested', 'æœªè¨­å®š');
            }

            const openaiKey = document.getElementById('openaiKey').value.trim();
            if (openaiKey) {
                updateAPIStatus('openaiStatus', 'untested', 'ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…å¿…è¦');
            } else {
                updateAPIStatus('openaiStatus', 'untested', 'æœªè¨­å®š');
            }

            checkAPIStatus();
        }

        async function testVisionAPIs() {
            const testImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=';

            // Test Gemini Vision API
            const geminiVisionKey = document.getElementById('geminiVisionKey').value.trim();
            if (geminiVisionKey) {
                updateAPIStatus('geminiVisionStatus', 'testing', 'ãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${geminiVisionKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "ã“ã®ç”»åƒã«ä½•ãŒå†™ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ" },
                                    { inline_data: { mime_type: 'image/jpeg', data: testImage.split(',')[1] } }
                                ]
                            }]
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateAPIStatus('geminiVisionStatus', 'connected', 'æ¥ç¶šOK');
                        console.log('Gemini Vision API test successful:', data);
                    } else {
                        const errorText = await response.text();
                        updateAPIStatus('geminiVisionStatus', 'disconnected', `ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        console.error('Gemini Vision API error:', response.status, errorText);
                    }
                } catch (error) {
                    updateAPIStatus('geminiVisionStatus', 'disconnected', `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error('Gemini Vision API network error:', error);
                }
            } else {
                updateAPIStatus('geminiVisionStatus', 'untested', 'æœªè¨­å®š');
            }

            // Test Google Vision API
            const visionKey = document.getElementById('visionKey').value.trim();
            if (visionKey) {
                updateAPIStatus('visionApiStatus', 'testing', 'ãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${visionKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requests: [{
                                image: { content: testImage.split(',')[1] },
                                features: [{ type: 'LABEL_DETECTION', maxResults: 1 }]
                            }]
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateAPIStatus('visionApiStatus', 'connected', 'æ¥ç¶šOK');
                        console.log('Google Vision API test successful:', data);
                    } else {
                        const errorText = await response.text();
                        updateAPIStatus('visionApiStatus', 'disconnected', `ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        console.error('Google Vision API error:', response.status, errorText);
                    }
                } catch (error) {
                    updateAPIStatus('visionApiStatus', 'disconnected', `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error('Google Vision API network error:', error);
                }
            } else {
                updateAPIStatus('visionApiStatus', 'untested', 'æœªè¨­å®š');
            }

            // Test Google Translate API
            const translateKey = document.getElementById('translateKey').value.trim();
            if (translateKey) {
                updateAPIStatus('translateStatus', 'testing', 'ãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${translateKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            q: 'Hello',
                            target: 'ja',
                            source: 'en'
                        })
                    });
                    
                    if (response.ok) {
                        updateAPIStatus('translateStatus', 'connected', 'æ¥ç¶šOK');
                    } else {
                        updateAPIStatus('translateStatus', 'disconnected', `ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                } catch (error) {
                    updateAPIStatus('translateStatus', 'disconnected', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
                }
            } else {
                updateAPIStatus('translateStatus', 'untested', 'æœªè¨­å®š');
            }

            // Test Text-to-Speech API
            const ttsKey = document.getElementById('ttsKey').value.trim();
            if (ttsKey) {
                updateAPIStatus('ttsStatus', 'testing', 'ãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${ttsKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input: { text: "ãƒ†ã‚¹ãƒˆ" },
                            voice: {
                                languageCode: 'ja-JP',
                                name: 'ja-JP-Standard-A'
                            },
                            audioConfig: {
                                audioEncoding: 'MP3'
                            }
                        })
                    });
                    
                    if (response.ok) {
                        updateAPIStatus('ttsStatus', 'connected', 'æ¥ç¶šOK');
                    } else {
                        updateAPIStatus('ttsStatus', 'disconnected', `ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                } catch (error) {
                    updateAPIStatus('ttsStatus', 'disconnected', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
                }
            } else {
                updateAPIStatus('ttsStatus', 'untested', 'æœªè¨­å®š');
            }

            checkAPIStatus();
        }

        function updateAPIStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `api-status ${status}`;
                element.textContent = text;
                
                // ãƒ­ã‚°ã«ã‚‚å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                console.log(`API Status Update - ${elementId}: ${status} - ${text}`);
            }
        }

        // Rest of the functions from original file
        function cleanMarkdown(text) {
            if (!text || typeof text !== 'string') return text || '';
            
            return text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/^\* /gm, 'â€¢ ')
                .replace(/^\d+\. /gm, '')
                .replace(/^#+\s*/gm, '')
                .replace(/```[\s\S]*?```/g, '')
                .replace(/`([^`]+)`/g, '$1')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/\n\s*\n/g, '\n')
                .trim();
        }

        // Chat Functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            conversationHistory.push({ role: 'user', content: message });
            showTypingIndicator();
            
            try {
                const response = await getAIResponse(message);
                hideTypingIndicator();
                addChatMessage('assistant', response);
                conversationHistory.push({ role: 'assistant', content: response });
                
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
            } catch (error) {
                hideTypingIndicator();
                addChatMessage('system', `AIå¿œç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function getAIResponse(message) {
            const provider = document.getElementById('aiProvider').value;
            
            let contextMessage = message;
            if (isVisionActive) {
                const visionContext = getVisionContext();
                contextMessage = `${message}\n\n[ç¾åœ¨ã®ç”»åƒåˆ†æã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${visionContext}]`;
            }
            
            switch (provider) {
                case 'gemini':
                    return await callGeminiChat(contextMessage);
                case 'claude':
                    return await callClaudeAPI(contextMessage);
                case 'gpt':
                    return await callOpenAIAPI(contextMessage);
                default:
                    return simulateAIResponse(contextMessage);
            }
        }

        async function callGeminiChat(message) {
            const apiKey = document.getElementById('geminiChatKey').value.trim();
            
            if (!apiKey) {
                return simulateAIResponse(message);
            }
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: message }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 1000,
                        temperature: 0.7
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Rest of the original functions...
        async function callClaudeAPI(message) {
            return simulateAIResponse(message);
        }

        async function callOpenAIAPI(message) {
            return simulateAIResponse(message);
        }

        function simulateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('ç”»åƒ') || lowerMessage.includes('åˆ†æ') || lowerMessage.includes('è¦‹ãˆ')) {
                if (!isVisionActive) {
                    return 'Live Vision Analysisã‚’é–‹å§‹ã™ã‚‹ã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç”»åƒåˆ†æãŒã§ãã¾ã™ã€‚å³å´ã®ã€ŒğŸš€ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    const visionContext = getVisionContext();
                    return `ç¾åœ¨ã®ç”»åƒåˆ†æçµæœã‚’ãŠä¼ãˆã—ã¾ã™ï¼š${visionContext}ã€‚ã•ã‚‰ã«è©³ã—ã„åˆ†æã‚„ç‰¹å®šã®éƒ¨åˆ†ã«ã¤ã„ã¦è³ªå•ãŒã‚ã‚Œã°ãŠèã‹ã›ãã ã•ã„ã€‚`;
                }
            }
            
            if (lowerMessage.includes('è¨­å®š') || lowerMessage.includes('API')) {
                return 'âš™ï¸è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã®è¨­å®šã‚„åˆ†æãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒã§ãã¾ã™ã€‚ä½•ã‹ç‰¹å®šã®è¨­å®šã«ã¤ã„ã¦ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ';
            }
            
            const responses = [
                'ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚Live Vision Analysisã‚·ã‚¹ãƒ†ãƒ ã§ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚',
                'AIç”»åƒåˆ†æã¨çµ±åˆãƒãƒ£ãƒƒãƒˆã§ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
                'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒåˆ†æã®çµæœã‚‚å‚è€ƒã«ã—ãªãŒã‚‰ãŠç­”ãˆã—ã¾ã™ã€‚ä»–ã«ã‚‚ã”è³ªå•ãŒã‚ã‚Œã°ã©ã†ãã€‚',
                'Live Vision AnalysisãŒæä¾›ã™ã‚‹è©³ç´°ãªç”»åƒæƒ…å ±ã‚’æ´»ç”¨ã—ã¦ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function getVisionContext() {
            if (!isVisionActive) return 'ç”»åƒåˆ†æã¯åœæ­¢ä¸­';
            
            const visionResults = document.getElementById('visionResults').textContent;
            const analysisResults = document.getElementById('analysisResults').textContent;
            
            return `ç‰©ä½“æ¤œå‡º: ${visionResults.slice(0, 100)}, AIåˆ†æ: ${analysisResults.slice(0, 100)}`;
        }

        function addChatMessage(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'assistant') {
                messageDiv.innerHTML = formatMessageContent(content);
            } else {
                messageDiv.textContent = content;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessageContent(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/`(.*?)`/g, '<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">$1</code>');
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Vision Analysis Functions (improved camera handling)
        async function toggleVision() {
            const btn = document.getElementById('visionToggle');
            
            if (!isVisionActive) {
                try {
                    updateStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...');
                    
                    // ã‚ˆã‚Šè©³ç´°ãªã‚«ãƒ¡ãƒ©è¨­å®šã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    const constraints = {
                        video: {
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            facingMode: 'environment' // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
                        }
                    };
                    
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ')), 10000);
                    });
                    
                    const mediaPromise = navigator.mediaDevices.getUserMedia(constraints);
                    
                    stream = await Promise.race([mediaPromise, timeoutPromise]);
                    
                    const video = document.getElementById('videoFeed');
                    video.srcObject = stream;
                    
                    // ãƒ“ãƒ‡ã‚ªãŒå†ç”Ÿæº–å‚™å®Œäº†ã¾ã§å¾…æ©Ÿ
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = () => reject(new Error('ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼'));
                        setTimeout(() => reject(new Error('ãƒ“ãƒ‡ã‚ªèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 5000);
                    });
                    
                    isVisionActive = true;
                    btn.textContent = 'â¹ï¸ åœæ­¢';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-danger');
                    
                    updateStatus('ğŸš€ Live Vision Analysis é–‹å§‹');
                    addChatMessage('system', 'Live Vision Analysis ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
                    
                    startAnalysis();
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    updateStatus('âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼');
                    
                    // ã‚ˆã‚Šå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    let errorMessage = 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ';
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚';
                    } else if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                        errorMessage += 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    addChatMessage('system', errorMessage);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ˆã‚ŠåŸºæœ¬çš„ãªè¨­å®šã§å†è©¦è¡Œ
                    if (!error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ') && !error.name === 'NotAllowedError') {
                        setTimeout(() => {
                            tryBasicCamera();
                        }, 2000);
                    }
                }
            } else {
                stopVision();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ã‚«ãƒ¡ãƒ©è¨­å®š
        async function tryBasicCamera() {
            try {
                updateStatus('ğŸ“¹ åŸºæœ¬è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’å†è©¦è¡Œä¸­...');
                addChatMessage('system', 'åŸºæœ¬è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’å†è©¦è¡Œã—ã¦ã„ã¾ã™...');
                
                // ã‚ˆã‚ŠåŸºæœ¬çš„ãªè¨­å®š
                const basicConstraints = {
                    video: true // æœ€ã‚‚åŸºæœ¬çš„ãªè¨­å®š
                };
                
                stream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                const video = document.getElementById('videoFeed');
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve);
                    };
                });
                
                isVisionActive = true;
                const btn = document.getElementById('visionToggle');
                btn.textContent = 'â¹ï¸ åœæ­¢';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                
                updateStatus('ğŸš€ Live Vision Analysis é–‹å§‹');
                addChatMessage('system', 'âœ… ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼ˆåŸºæœ¬è¨­å®šï¼‰');
                
                startAnalysis();
                
            } catch (fallbackError) {
                console.error('Fallback camera error:', fallbackError);
                updateStatus('âŒ ã‚«ãƒ¡ãƒ©åˆ©ç”¨ä¸å¯');
                addChatMessage('system', `âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${fallbackError.message}`);
            }
        }

        function stopVision() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            isVisionActive = false;
            isProcessing = false;
            const btn = document.getElementById('visionToggle');
            btn.textContent = 'ğŸš€ é–‹å§‹';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
            
            updateStatus('â¹ï¸ Live Vision Analysis åœæ­¢');
            addChatMessage('system', 'Live Vision Analysis ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ');
        }

        function startAnalysis() {
            lastAnalysisTime = 0;
            performAnalysis();
            
            const interval = parseInt(document.getElementById('intervalSelect').value);
            analysisInterval = setInterval(performAnalysis, interval);
        }

        async function performAnalysis() {
            if (!isVisionActive || isProcessing) return;

            const now = Date.now();
            const interval = parseInt(document.getElementById('intervalSelect').value);
            const timeSinceLastAnalysis = now - lastAnalysisTime;
            
            if (lastAnalysisTime > 0 && timeSinceLastAnalysis < interval - 100) {
                updateStatus(`â³ å¾…æ©Ÿä¸­ (${Math.round((interval - timeSinceLastAnalysis) / 1000)}s)`);
                return;
            }

            isProcessing = true;
            lastAnalysisTime = now;
            const startTime = Date.now();
            updateStatus('ğŸ”„ åˆ†æä¸­...');

            try {
                const imageBase64 = captureFrame();
                if (!imageBase64) {
                    throw new Error('ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—');
                }

                let visionData = null;
                let analysisText = '';
                let translationText = '';

                // Step 1: Vision API Analysis
                const visionKey = document.getElementById('visionKey').value.trim();
                if (visionKey) {
                    try {
                        visionData = await analyzeWithVision(imageBase64);
                        const labels = visionData.labelAnnotations?.map(l => `${l.description} (${Math.round(l.score * 100)}%)`).join(', ') || 'None';
                        const objects = visionData.localizedObjectAnnotations?.map(o => o.name).join(', ') || 'None';
                        const texts = visionData.textAnnotations?.[0]?.description || 'None';
                        
                        document.getElementById('visionResults').textContent = `Labels: ${labels}\nObjects: ${objects}\nText: ${texts}`;
                    } catch (error) {
                        document.getElementById('visionResults').textContent = `Error: ${error.message}`;
                    }
                }

                // Step 2: Gemini Analysis
                const geminiKey = document.getElementById('geminiVisionKey').value.trim();
                if (geminiKey) {
                    try {
                        const instruction = document.getElementById('customInstruction').value.trim() || 
                                          defaultInstructions[document.getElementById('analysisMode').value];
                        
                        const rawText = await analyzeWithGemini(imageBase64, instruction);
                        analysisText = cleanMarkdown(rawText);
                        document.getElementById('analysisResults').textContent = analysisText;
                    } catch (error) {
                        if (visionData && visionData.labelAnnotations) {
                            analysisText = `æ¤œå‡º: ${visionData.labelAnnotations.slice(0, 3).map(l => l.description).join(', ')}`;
                            document.getElementById('analysisResults').textContent = `[ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯] ${analysisText}`;
                        } else {
                            document.getElementById('analysisResults').textContent = `Error: ${error.message}`;
                        }
                    }
                }

                // Step 3: Translation
                const translateKey = document.getElementById('translateKey').value.trim();
                if (translateKey && analysisText) {
                    try {
                        translationText = await translateText(analysisText);
                        document.getElementById('translationResults').textContent = translationText;
                    } catch (error) {
                        document.getElementById('translationResults').textContent = `Translation error: ${error.message}`;
                    }
                }

                // Step 4: Speech
                if (document.getElementById('autoSpeech').checked && translationText && !translationText.includes('error')) {
                    await speakText(translationText);
                }

                // Update analytics
                const processingTime = (Date.now() - startTime) / 1000;
                analytics.total++;
                if (analysisText && !analysisText.includes('Error')) {
                    analytics.successful++;
                }
                analytics.totalProcessingTime += processingTime;
                analytics.estimatedCost += calculateCost(visionData, analysisText, translationText);

                updateStatus(`âœ… åˆ†æå®Œäº† ${processingTime.toFixed(1)}s`);

            } catch (error) {
                console.error('Analysis error:', error);
                updateStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                analytics.total++;
            } finally {
                isProcessing = false;
            }
        }

        function captureFrame() {
            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // API Functions (keeping original implementation)
        async function analyzeWithVision(imageBase64) {
            const apiKey = document.getElementById('visionKey').value.trim();
            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{
                        image: { content: imageBase64.split(',')[1] },
                        features: [
                            { type: 'LABEL_DETECTION', maxResults: 10 },
                            { type: 'OBJECT_LOCALIZATION', maxResults: 10 },
                            { type: 'TEXT_DETECTION', maxResults: 1 }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Vision API error: ${response.status}`);
            }

            const data = await response.json();
            return data.responses[0];
        }

        async function analyzeWithGemini(imageBase64, instruction) {
            const apiKey = document.getElementById('geminiVisionKey').value.trim();
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: instruction },
                            { inline_data: { mime_type: 'image/jpeg', data: imageBase64.split(',')[1] } }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function translateText(text) {
            const apiKey = document.getElementById('translateKey').value.trim();
            const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    q: text,
                    target: 'ja',
                    source: 'en'
                })
            });

            if (!response.ok) {
                throw new Error(`Translate API error: ${response.status}`);
            }

            const data = await response.json();
            return data.data.translations[0].translatedText;
        }

        async function speakText(text) {
            const apiKey = document.getElementById('ttsKey').value.trim();
            if (!apiKey || !text) return;

            try {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                const cleanText = cleanMarkdown(text);
                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: { text: cleanText },
                        voice: {
                            languageCode: 'ja-JP',
                            name: 'ja-JP-Standard-A',
                            ssmlGender: 'FEMALE'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: parseFloat(document.getElementById('speechSpeed').value)
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS API error: ${response.status}`);
                }

                const data = await response.json();
                const audioBlob = new Blob([Uint8Array.from(atob(data.audioContent), c => c.charCodeAt(0))], {
                    type: 'audio/mp3'
                });
                
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                };
                
                await currentAudio.play();
                document.getElementById('speechResults').textContent = `éŸ³å£°å†ç”Ÿä¸­: ${cleanText.substring(0, 50)}...`;
            } catch (error) {
                document.getElementById('speechResults').textContent = `éŸ³å£°ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        // Utility Functions
        function captureAndSend() {
            if (!isVisionActive) {
                addChatMessage('system', 'Live Vision Analysisã‚’é–‹å§‹ã—ã¦ã‹ã‚‰ç”»åƒã‚’å…±æœ‰ã—ã¦ãã ã•ã„');
                return;
            }
            
            const visionResults = document.getElementById('visionResults').textContent;
            const analysisResults = document.getElementById('analysisResults').textContent;
            const translationResults = document.getElementById('translationResults').textContent;
            
            const imageContext = `ğŸ“· **Live Vision Analysisçµæœã‚’å…±æœ‰ã—ã¾ã—ãŸ**\n\nğŸ” **ç‰©ä½“æ¤œå‡º**: ${visionResults}\nğŸ¤– **AIåˆ†æ**: ${analysisResults}\nğŸŒ **ç¿»è¨³**: ${translationResults}`;
            
            addChatMessage('system', imageContext);
            
            conversationHistory.push({
                role: 'user',
                content: `[Live Vision Analysisçµæœ] æ¤œå‡º: ${visionResults}, åˆ†æ: ${analysisResults}`
            });
            
            setTimeout(async () => {
                try {
                    const response = await getAIResponse('ã“ã®ç”»åƒåˆ†æçµæœã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚');
                    addChatMessage('assistant', response);
                    conversationHistory.push({ role: 'assistant', content: response });
                } catch (error) {
                    addChatMessage('assistant', 'Live Vision Analysisçµæœã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã“ã®æƒ…å ±ã‚’åŸºã«ã‚µãƒãƒ¼ãƒˆã‚’ç¶šã‘ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚');
                }
            }, 1500);
        }

        function toggleSpeech() {
            speechEnabled = !speechEnabled;
            const btn = document.getElementById('speechBtn');
            
            if (speechEnabled) {
                btn.textContent = 'ğŸ”Š éŸ³å£°ON';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            } else {
                btn.textContent = 'ğŸ”‡ éŸ³å£°OFF';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
            }
        }

        function takeSnapshot() {
            if (!isVisionActive) {
                addChatMessage('system', 'Live Vision Analysisã‚’é–‹å§‹ã—ã¦ã‹ã‚‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„');
                return;
            }
            
            const imageData = captureFrame();
            addChatMessage('system', 'ğŸ“¸ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¾ã—ãŸ');
            
            // In real implementation, this would save or process the image
            console.log('Snapshot captured:', imageData.substring(0, 50) + '...');
        }

        function updateStatus(message) {
            document.getElementById('statusIndicator').textContent = message;
            document.getElementById('statusOverlay').textContent = message;
        }

        function calculateCost(visionData, analysisText, translationText) {
            let cost = 0;
            
            if (visionData) {
                cost += 0.0015; // Vision API: $1.50 per 1000 images
            }
            
            if (analysisText) {
                const estimatedTokens = 258 + 50 + 100; // Image + input + output tokens
                cost += (estimatedTokens / 1000000) * 7; // Gemini: $7 per 1M tokens
            }
            
            if (translationText) {
                const chars = analysisText?.length || 0;
                cost += (chars / 1000000) * 20; // Translate: $20 per 1M chars
            }
            
            if (translationText && document.getElementById('autoSpeech').checked) {
                const chars = translationText.length;
                cost += (chars / 1000000) * 4; // TTS: $4 per 1M chars
            }
            
            return cost;
        }

        function updateAnalyticsDisplay() {
            document.getElementById('totalAnalyses').textContent = analytics.total;
            document.getElementById('successRate').textContent = analytics.total > 0 ? 
                `${Math.round((analytics.successful / analytics.total) * 100)}%` : '0%';
            document.getElementById('totalCost').textContent = `${analytics.estimatedCost.toFixed(4)}`;
            document.getElementById('avgTime').textContent = analytics.total > 0 ? 
                `${(analytics.totalProcessingTime / analytics.total).toFixed(1)}s` : '0.0s';
        }
    </script>
</body>
</html>